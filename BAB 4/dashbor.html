<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Pertanian</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--green:#2f855a;--dark:#123}
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,system-ui,Arial,sans-serif;
      margin:0;
      background:linear-gradient(rgba(255,255,255,0.3),rgba(255,255,255,0.3)),
                 url('./assets/Harvest.jpg') center/cover no-repeat fixed;
      background-color:#f0f4f8;
      color:var(--dark);
      min-height:100vh;
    }
    header{background:var(--green);color:#fff;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .container{max-width:1200px;margin:20px auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;margin-bottom:20px}
    .card{background:#fff;padding:22px;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.12)}
    .btn{background:var(--green);color:#fff;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;margin:4px 0;font-size:.9rem}
    .btn:hover{background:#276749}
    .logout{background:#dc2626;float:right}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.9rem}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #e5e7eb}
    th{background:var(--green);color:#fff}
    #snackbar{visibility:hidden;min-width:260px;margin-left:-130px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:14px;position:fixed;left:50%;bottom:30px;z-index:1000;opacity:0}
    #snackbar.show{visibility:visible;opacity:1;transform:translateY(0);transition:opacity .35s}
    #snackbar.success{background:#16a34a}#snackbar.error{background:#dc2626}
  </style>
</head>
<body>
  <header>
    <div style="font-weight:700">Dashboard</div>
    <div>
      <span id="userInfo" style="margin-right:12px;color:#d1fae5"></span>
      <button class="btn logout" onclick="localStorage.removeItem('user');location.href='index.html'">Logout</button>
    </div>
  </header>

  <div class="container">
    <h1>Monitoring Pertanian</h1>
    <p id="welcomeMsg">Memuat...</p>

    <div class="grid">
      <div class="card">
        <h2>Statistik</h2>
        <p>Tanaman: <strong id="countTanaman">0</strong></p>
        <p>Panen: <strong id="countPanen">0</strong></p>
        <p>Total: <strong id="totalPanen">0</strong> Ton</p>
      </div>
      <div class="card">
        <h2>Grafik Panen (7 Hari)</h2>
        <canvas id="chartPanen" height="200"></canvas>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Daftar Tanaman</h2>
        <button class="btn" onclick="refreshTanaman()">Refresh</button>
        <table id="tabelTanaman"><thead><tr><th>ID</th><th>Nama</th><th>Ditanam</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card">
        <h2>Panen Terbaru</h2>
        <button class="btn" onclick="refreshPanen()">Refresh</button>
        <table id="tabelPanen"><thead><tr><th>ID</th><th>Panen</th><th>Ton</th><th>Tanggal</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div id="snackbar"></div>

  <script>
    function showToast(m,t,d=3000){const s=document.getElementById('snackbar');s.textContent=m;s.className='show';if(t==='success')s.classList.add('success');if(t==='error')s.classList.add('error');setTimeout(()=>{s.className='';},d);}
    const u=JSON.parse(localStorage.getItem('user')||'{}');
    if(!u.isLoggedIn){showToast('Login dulu!','error');setTimeout(()=>location.href='login.html',1500);return;}
    document.getElementById('welcomeMsg').textContent=`Selamat datang, ${u.nama}!`;
    document.getElementById('userInfo').textContent=`(${u.email})`;

    const getT=()=>JSON.parse(localStorage.getItem('tanaman')||'[]'), getP=()=>JSON.parse(localStorage.getItem('panen')||'[]');
    function updateStats(){
      document.getElementById('countTanaman').textContent=getT().length;
      document.getElementById('countPanen').textContent=getP().length;
      document.getElementById('totalPanen').textContent=getP().reduce((s,x)=>s+(parseFloat(x.ton)||0),0).toFixed(2);
    }
    function renderTanaman(){
      const b=document.querySelector('#tabelTanaman tbody');b.innerHTML='';
      getT().forEach(x=>{const r=b.insertRow();r.insertCell(0).textContent=x.id;r.insertCell(1).textContent=x.nama;r.insertCell(2).textContent=x.ditanam;});
    }
    function renderPanen(){
      const b=document.querySelector('#tabelPanen tbody');b.innerHTML='';
      getP().slice(-10).reverse().forEach(x=>{const r=b.insertRow();r.insertCell(0).textContent=x.id;r.insertCell(1).textContent=x.nama;r.insertCell(2).textContent=x.ton;r.insertCell(3).textContent=x.tanggal;});
    }
    function renderChart(){
      const ctx=document.getElementById('chartPanen').getContext('2d');
      const data=getP().slice(-7).reverse();
      new Chart(ctx,{type:'line',data:{labels:data.map(x=>new Date(x.tanggal).toLocaleDateString()),datasets:[{label:'Ton',data:data.map(x=>parseFloat(x.ton)),borderColor:'#2f855a',backgroundColor:'rgba(47,133,90,0.1)',fill:true}]},options:{responsive:true}});
    }
    function refreshTanaman(){renderTanaman();showToast('Daftar diperbarui','success');}
    function refreshPanen(){renderPanen();showToast('Daftar diperbarui','success');}
    updateStats();renderTanaman();renderPanen();renderChart();
  </script>
</body>
</html>